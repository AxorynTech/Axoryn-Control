<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Conta | Axoryn Control</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- ESTILOS ORIGINAIS MANTIDOS --- */
        :root { --primary: #2980B9; --dark: #2C3E50; --success: #27AE60; --danger: #E74C3C; --warning: #F39C12; --bg: #F4F6F7; --card-bg: #FFFFFF; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--bg); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            color: #333; 
        }
        
        .container { 
            background: var(--card-bg); 
            padding: 40px; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            width: 90%; 
            max-width: 450px; 
            text-align: center; 
            position: relative; 
            z-index: 1;
        }
        
        /* BANDEIRAS FIXAS */
        .lang-selector { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: white; 
            padding: 8px 15px; 
            border-radius: 30px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            display: flex; 
            gap: 12px; 
            z-index: 9999; 
        }
        
        .lang-btn { 
            background: none; border: none; font-size: 26px; cursor: pointer; 
            opacity: 1; filter: none; transition: transform 0.2s; padding: 0; line-height: 1;
        }
        .lang-btn:hover { transform: scale(1.2); }
        .lang-btn.active { transform: scale(1.2); border-bottom: 2px solid var(--primary); }

        h1 { margin: 0 0 5px 0; color: var(--dark); font-size: 24px; }
        p.subtitle { color: #7F8C8D; font-size: 14px; margin-bottom: 25px; }
        
        /* Inputs */
        .input-group { position: relative; margin-bottom: 15px; text-align: left; }
        .input-group label { font-size: 12px; font-weight: bold; color: #7F8C8D; margin-left: 2px; }
        input { width: 100%; padding: 14px; margin-top: 5px; border: 1px solid #DDD; border-radius: 8px; box-sizing: border-box; font-size: 16px; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); }
        
        .password-toggle { position: absolute; right: 15px; top: 38px; cursor: pointer; color: #999; }
        .password-toggle:hover { color: var(--primary); }

        /* Bot√µes */
        button { width: 100%; padding: 14px; background-color: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        button:hover { background-color: #1F618D; }
        button:disabled { background-color: #BDC3C7; cursor: not-allowed; }
        button.btn-outline { background: transparent; border: 1px solid #BDC3C7; color: #7F8C8D; margin-top: 20px; font-size: 14px; }
        
        .link-recuperar { 
            display: block; text-align: center; margin-bottom: 15px; font-size: 13px; color: var(--primary); text-decoration: none; margin-top: 5px;
        }
        .link-recuperar:hover { text-decoration: underline; }

        /* Dashboard */
        .user-header { margin-bottom: 20px; }
        .stats-grid { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: #F8F9FA; padding: 10px; border-radius: 8px; border: 1px solid #EEE; }
        .stat-label { font-size: 11px; color: #888; text-transform: uppercase; font-weight: bold; }
        .stat-value { font-size: 14px; font-weight: bold; color: var(--dark); margin-top: 3px; }
        
        .status-box { background: #FFF; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #EEE; text-align: left; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .status-title { font-weight: bold; font-size: 14px; color: var(--dark); }
        .status-badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
        .status-msg { font-size: 13px; color: #666; margin-bottom: 10px; line-height: 1.4; }

        .progress-container { background: #EEE; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-bar { height: 100%; background: var(--success); width: 0%; transition: width 0.5s; }

        /* SELETOR DE PA√çS */
        .country-selector { display: flex; background: #F8F9FA; border: 1px solid #EEE; border-radius: 8px; padding: 5px; margin-bottom: 15px; flex-direction: column; gap: 5px; }
        .country-btn { width: 100%; padding: 12px; font-size: 13px; font-weight: bold; border: none; background: transparent; color: #777; border-radius: 6px; cursor: pointer; text-align: left; display: flex; justify-content: space-between; align-items: center; margin-top:0; }
        .country-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #DDD; }
        .country-btn i { font-size: 18px; }

        /* Cards de Pagamento */
        .plans-grid { display: flex; gap: 10px; margin-top: 15px; }
        .plan-card { flex: 1; border: 1px solid #DDD; border-radius: 10px; padding: 15px 10px; cursor: pointer; transition: 0.2s; position: relative; background: white; }
        .plan-card:hover { border-color: var(--primary); background: #F4FAFF; }
        .plan-title { font-size: 13px; font-weight: bold; color: #555; }
        .plan-price { font-size: 20px; font-weight: bold; color: var(--primary); margin: 5px 0; }
        .plan-period { font-size: 11px; color: #999; }
        .best-value { position: absolute; top: -10px; right: 50%; transform: translateX(50%); background: var(--success); color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; white-space: nowrap; font-weight: bold; }

        /* Estilo Recargas */
        .card-recarga { border-color: #FDEBD0; }
        .card-recarga:hover { border-color: var(--warning); background: #FEF9E7; }
        .price-recarga { color: var(--warning); }
        .tag-recarga { position: absolute; top: -10px; right: 50%; transform: translateX(50%); background: var(--warning); color: white; font-size: 9px; padding: 2px 8px; border-radius: 10px; white-space: nowrap; font-weight: bold; }

        /* Utilit√°rios */
        .hidden { display: none !important; }
        .error { color: var(--danger); font-size: 13px; margin-bottom: 15px; background: #FDEDEC; padding: 10px; border-radius: 6px; }
        .text-green { color: var(--success); }
        .bg-green-light { background: #E8F8F5; color: var(--success); }
        .bg-red-light { background: #FDEDEC; color: var(--danger); }
        .debug-info { font-size: 9px; color: #ccc; margin-top: 30px; text-align: center; }

        /* MODAL DE DADOS (Mercado Pago) */
        #modal-mp-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10000;
            align-items: center; justify-content: center;
        }
        #modal-mp-card {
            background: #fff; padding: 25px; border-radius: 12px;
            width: 90%; max-width: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-family: sans-serif; text-align: left;
        }
        #modal-mp-card h3 { margin-top: 0; color: #333; text-align: center; margin-bottom: 15px; }
        .mp-input-group { margin-bottom: 15px; }
        .mp-input-group label { display: block; font-size: 14px; margin-bottom: 5px; color: #666; font-weight: bold; }
        .mp-input-group input { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; 
            font-size: 16px; box-sizing: border-box; 
        }
        .mp-btn-pay { 
            width: 100%; background: #009EE3; color: white; border: none; 
            padding: 12px; font-size: 16px; border-radius: 6px; cursor: pointer; font-weight: bold;
            margin-top: 10px;
        }
        .mp-btn-pay:hover { background: #007eb5; }
        .mp-btn-close { 
            background: transparent; color: #999; border: none; float: right; 
            font-size: 24px; cursor: pointer; line-height: 1; margin-top: -10px; margin-right: -10px;
        }
    </style>
</head>
<body>

    <div class="lang-selector">
        <button class="lang-btn active" onclick="setLanguage('pt')" title="Portugu√™s">üáßüá∑</button>
        <button class="lang-btn" onclick="setLanguage('en')" title="English">üá∫üá∏</button>
        <button class="lang-btn" onclick="setLanguage('es')" title="Espa√±ol">üá™üá∏</button>
    </div>

    <div class="container">
        
        <div id="loginScreen">
            <h1>Axoryn Control</h1>
            <p class="subtitle" data-i18n="portal_subtitle">Portal do Cliente</p>
            <div id="loginError" class="hidden error"></div>
            <div class="input-group">
                <label data-i18n="label_email">E-MAIL</label>
                <input type="email" id="email" placeholder="seu@email.com" />
            </div>
            <div class="input-group">
                <label data-i18n="label_password">SENHA</label>
                <input type="password" id="password" placeholder="******" />
                <i class="fas fa-eye password-toggle" onclick="toggleSenha()"></i>
            </div>
            
            <a href="recuperar.html" class="link-recuperar" data-i18n="forgot_password">Esqueceu a senha?</a>

            <button onclick="fazerLogin()" id="btnLogin" data-i18n="btn_login">Acessar Conta</button>
        </div>

        <div id="dashboardScreen" class="hidden">
            <div class="user-header">
                <h1><span data-i18n="hello">Ol√°</span>, <span id="userName">Usu√°rio</span></h1>
                <p style="font-size:13px; color:#777; margin:0;" id="userEmail">carregando...</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label" data-i18n="current_plan">Plano Atual</div>
                    <div class="stat-value" id="infoPlan">Verificando...</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label" data-i18n="expiration">Vencimento</div>
                    <div class="stat-value" id="infoDate">--/--/----</div>
                </div>
            </div>

            <div class="status-box">
                <div class="status-header">
                    <span class="status-title" data-i18n="status_title">Situa√ß√£o</span>
                    <span id="badgeStatus" class="status-badge bg-green-light">ATIVO</span>
                </div>
                <div class="status-msg" id="statusMessage">Calculando dias restantes...</div>
                <div id="progressContainer" class="progress-container hidden">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>

            <div id="areaSeletor" class="country-selector hidden">
                <button class="country-btn active" id="btnBR" onclick="mudarRegiao('br')">
                    <span>üáßüá∑ Brasil <small>(Mercado Pago)</small></span>
                    <i class="fas fa-check-circle text-green"></i>
                </button>
                <button class="country-btn" id="btnINTL" onclick="mudarRegiao('intl')">
                    <span>üåé International <small>(Stripe)</small></span>
                    <i class="fas fa-circle" style="color:#ddd"></i>
                </button>
            </div>

            <div id="areaPagamento" class="hidden">
                <p style="font-weight:bold; margin-bottom:10px; color:#2C3E50; font-size:14px;" data-i18n="renew_title">Renovar Assinatura:</p>
                
                <div class="plans-grid">
                    <div class="plan-card" onclick="pagar('mensal')">
                        <div class="plan-title" data-i18n="plan_monthly">MENSAL</div>
                        <div class="plan-price" id="priceMensal">R$ 14,99</div>
                        <div class="plan-period" data-i18n="period_monthly">Cobrado todo m√™s</div>
                    </div>
                    
                    <div class="plan-card" onclick="pagar('anual')">
                        <div class="best-value">-15% OFF</div>
                        <div class="plan-title" data-i18n="plan_annual">ANUAL</div>
                        <div class="plan-price" id="priceAnual">R$ 149,90</div>
                        <div class="plan-period" data-i18n="period_annual">Cobrado uma vez</div>
                    </div>
                </div>
            </div>

            <div id="areaRecargas" class="hidden">
                <hr style="border:0; border-top:1px solid #EEE; margin:20px 0;">
                <p style="font-weight:bold; margin-bottom:10px; color:#E67E22; font-size:14px;">
                    <i class="fas fa-bolt"></i> <span data-i18n="refills_title">Recargas Axoryn Shield:</span>
                </p>
                <div class="plans-grid">
                    <div class="plan-card card-recarga" onclick="pagar('recarga')">
                        <div class="tag-recarga" data-i18n="tag_pack">PACOTE</div>
                        <div class="plan-title" data-i18n="pack_10">10 CONSULTAS</div>
                        <div class="plan-price price-recarga" id="priceRecarga">R$ 20,00</div>
                        <div class="plan-period" id="textRecarga">R$ 2,00 por consulta</div>
                    </div>
                </div>
                <p style="font-size:11px; color:#999; margin-top:15px;" id="securePaymentText">
                    <i class="fas fa-lock"></i> <span data-i18n="secure_payment">Pagamento seguro</span>
                </p>
            </div>

            <div id="areaQuarentena" class="hidden">
                <div style="padding:20px; background:#F8F9FA; border-radius:8px; border:1px solid #EEE; color:#555; font-size:14px; margin-top:15px;">
                    <i class="fas fa-check-circle" style="color:#27AE60; font-size:20px; margin-bottom:10px;"></i><br>
                    <strong data-i18n="camouf_title">Conta Ativada com Sucesso</strong><br>
                    <span data-i18n="camouf_msg">Aproveite o Axoryn Control!</span><br>
                </div>
            </div>
            
            <div id="areaPremium" class="hidden">
                <div style="padding:20px; background:#F8F9FA; border-radius:8px; border:1px solid #EEE; color:#555; font-size:14px; margin-top:15px;">
                    <i class="fas fa-check-circle" style="color:#27AE60; font-size:20px; margin-bottom:10px;"></i><br>
                    <strong data-i18n="premium_active">Conta Premium Ativa</strong><br>
                    <span data-i18n="resources_unlocked">Todos os recursos liberados.</span><br>
                </div>
            </div>

            <button onclick="sair()" class="btn-outline" data-i18n="btn_logout">Sair da conta</button>
            
            <div id="debugInfo" class="debug-info"></div>
        </div>
    </div>

    <div id="modal-mp-overlay">
        <div id="modal-mp-card">
            <button class="mp-btn-close" onclick="fecharModalMP()">&times;</button>
            <h3 data-i18n="modal_title">Dados para Nota Fiscal</h3>
            <p style="font-size: 13px; color: #777; margin-bottom: 20px; text-align: center;" data-i18n="modal_desc">
                Necess√°rio para emiss√£o do pagamento no Brasil (CPF).
            </p>
            
            <div class="mp-input-group">
                <label data-i18n="label_name">Nome</label>
                <input type="text" id="mp-nome" placeholder="">
            </div>

            <div class="mp-input-group">
                <label data-i18n="label_surname">Sobrenome</label>
                <input type="text" id="mp-sobrenome" placeholder="">
            </div>

            <div class="mp-input-group">
                <label>CPF</label>
                <input type="tel" id="mp-cpf" placeholder="000.000.000-00" maxlength="14" oninput="mascaraCPF(this)">
            </div>

            <button class="mp-btn-pay" onclick="confirmarPagamentoMP()" data-i18n="btn_pay">
                Ir para Pagamento üîí
            </button>
        </div>
    </div>

    <script>
        // --- TRADU√á√ïES COMPLETAS (COM MODAL E ALERTAS) ---
        const translations = {
            pt: {
                portal_subtitle: "Portal do Cliente", label_email: "E-MAIL", label_password: "SENHA", forgot_password: "Esqueceu a senha?", btn_login: "Acessar Conta",
                hello: "Ol√°", current_plan: "Plano Atual", expiration: "Vencimento", status_title: "Situa√ß√£o", renew_title: "Renovar Assinatura:",
                plan_monthly: "MENSAL", period_monthly: "Cobrado todo m√™s", plan_annual: "ANUAL", period_annual: "Cobrado uma vez",
                refills_title: "Recargas Axoryn Shield:", tag_pack: "PACOTE", pack_10: "10 CONSULTAS", btn_logout: "Sair da conta",
                camouf_title: "Conta Ativada com Sucesso", camouf_msg: "Aproveite o Axoryn Control!", premium_active: "Conta Premium Ativa", resources_unlocked: "Todos os recursos liberados.",
                msg_new_account: "Sua conta est√° ativa e verificada.", msg_premium: "Sua assinatura est√° v√°lida.", msg_trial: "Per√≠odo de teste ativo.", msg_expired: "Seu per√≠odo gratuito acabou.",
                secure_payment: "Pagamento seguro",
                // Modal e Alertas
                modal_title: "Dados para Nota Fiscal", modal_desc: "Necess√°rio para emiss√£o do pagamento no Brasil (CPF).",
                label_name: "Nome", label_surname: "Sobrenome", btn_pay: "Ir para Pagamento üîí",
                alert_fill_all: "Por favor, preencha todos os campos para a NF.",
                alert_processing: "Processando...",
                alert_error_pay: "Erro ao criar pagamento: ",
                alert_conn_error: "Erro de conex√£o.",
                txt_per_query: "por consulta"
            },
            en: {
                portal_subtitle: "Client Portal", label_email: "EMAIL", label_password: "PASSWORD", forgot_password: "Forgot password?", btn_login: "Login",
                hello: "Hello", current_plan: "Current Plan", expiration: "Expiration", status_title: "Status", renew_title: "Renew Subscription:",
                plan_monthly: "MONTHLY", period_monthly: "Billed monthly", plan_annual: "ANNUAL", period_annual: "Billed once",
                refills_title: "Axoryn Shield Credits:", tag_pack: "PACK", pack_10: "10 LOOKUPS", btn_logout: "Logout",
                camouf_title: "Account Activated", camouf_msg: "Enjoy Axoryn Control!", premium_active: "Premium Active", resources_unlocked: "All features unlocked.",
                msg_new_account: "Your account is active and verified.", msg_premium: "Your subscription is valid.", msg_trial: "Free trial active.", msg_expired: "Your trial has ended.",
                secure_payment: "Secure payment",
                // Modal e Alertas
                modal_title: "Invoice Data", modal_desc: "Required for payment issuance in Brazil (CPF).",
                label_name: "Name", label_surname: "Surname", btn_pay: "Go to Payment üîí",
                alert_fill_all: "Please fill in all fields.",
                alert_processing: "Processing...",
                alert_error_pay: "Error creating payment: ",
                alert_conn_error: "Connection error.",
                txt_per_query: "/ lookup"
            },
            es: {
                portal_subtitle: "Portal del Cliente", label_email: "CORREO", label_password: "CONTRASE√ëA", forgot_password: "¬øOlvidaste tu contrase√±a?", btn_login: "Acceder",
                hello: "Hola", current_plan: "Plan Actual", expiration: "Vencimiento", status_title: "Situaci√≥n", renew_title: "Renovar Suscripci√≥n:",
                plan_monthly: "MENSUAL", period_monthly: "Cobrado cada mes", plan_annual: "ANUAL", period_annual: "Cobrado una vez",
                refills_title: "Recargas Axoryn Shield:", tag_pack: "PAQUETE", pack_10: "10 CONSULTAS", btn_logout: "Cerrar Sesi√≥n",
                camouf_title: "Cuenta Activada", camouf_msg: "¬°Disfruta Axoryn Control!", premium_active: "Premium Activo", resources_unlocked: "Todos los recursos liberados.",
                msg_new_account: "Tu cuenta est√° activa y verificada.", msg_premium: "Tu suscripci√≥n es v√°lida.", msg_trial: "Prueba gratuita activa.", msg_expired: "Tu periodo gratuito ha terminado.",
                secure_payment: "Pago seguro",
                // Modal e Alertas
                modal_title: "Datos de Facturaci√≥n", modal_desc: "Necesario para la emisi√≥n del pago en Brasil (CPF).",
                label_name: "Nombre", label_surname: "Apellido", btn_pay: "Ir al Pago üîí",
                alert_fill_all: "Por favor complete todos los campos.",
                alert_processing: "Procesando...",
                alert_error_pay: "Error al crear pago: ",
                alert_conn_error: "Error de conexi√≥n.",
                txt_per_query: "por consulta"
            }
        };

        let currentLang = 'pt';
        let currentRegion = 'br'; 
        let pedidoAtual = null; 

        // Config Supabase
        const SUPABASE_URL = "https://pcbywklgjmampecvgkqf.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBjYnl3a2xnam1hbXBlY3Zna3FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwOTc1NjYsImV4cCI6MjA4MzY3MzU2Nn0.6BaIetmxJIEGKE-dR4_nt4GgjkOJfM1L4nbuYEGIo1g";
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const loginScreen = document.getElementById('loginScreen');
        const dashboardScreen = document.getElementById('dashboardScreen');
        const feedback = document.getElementById('loginError');

        supabaseClient.auth.getUser().then(({ data, error }) => {
            if (data?.user) carregarDashboard(data.user);
        });

        function setLanguage(lang) {
            currentLang = lang;
            
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.lang-btn[onclick="setLanguage('${lang}')"]`).classList.add('active');

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });

            // Atualiza inputs placeholder se necess√°rio
            if(lang === 'en') {
                document.getElementById('mp-nome').placeholder = "First Name";
                document.getElementById('mp-sobrenome').placeholder = "Last Name";
            } else if(lang === 'es') {
                document.getElementById('mp-nome').placeholder = "Nombre";
                document.getElementById('mp-sobrenome').placeholder = "Apellido";
            } else {
                document.getElementById('mp-nome').placeholder = "Seu primeiro nome";
                document.getElementById('mp-sobrenome').placeholder = "Seu sobrenome";
            }

            mudarRegiao(currentRegion); 
        }

        function toggleSenha() {
            const passInput = document.getElementById('password');
            const icon = document.querySelector('.password-toggle');
            passInput.type = passInput.type === "password" ? "text" : "password";
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        }

        function mudarRegiao(regiao) {
            currentRegion = regiao;
            const btnBR = document.getElementById('btnBR');
            const btnINTL = document.getElementById('btnINTL');
            const suffix = translations[currentLang].txt_per_query;
            
            if (regiao === 'br') {
                btnBR.classList.add('active');
                btnBR.querySelector('i').className = "fas fa-check-circle text-green";
                btnINTL.classList.remove('active');
                btnINTL.querySelector('i').className = "fas fa-circle";
                btnINTL.querySelector('i').style.color = "#ddd";

                // --- PRE√áOS BRASIL (MERCADO PAGO) ---
                document.getElementById('priceMensal').innerText = "R$ 14,99";
                document.getElementById('priceAnual').innerText = "R$ 149,90";
                document.getElementById('priceRecarga').innerText = "R$ 20,00";
                document.getElementById('textRecarga').innerText = "R$ 2,00 " + suffix;
            } else {
                btnINTL.classList.add('active');
                btnINTL.querySelector('i').className = "fas fa-check-circle text-green";
                btnBR.classList.remove('active');
                btnBR.querySelector('i').className = "fas fa-circle";
                btnBR.querySelector('i').style.color = "#ddd";

                // --- PRE√áOS INTERNACIONAL (STRIPE) ---
                document.getElementById('priceMensal').innerText = "$ 9.90";
                document.getElementById('priceAnual').innerText = "$ 99.00";
                document.getElementById('priceRecarga').innerText = "$ 10.00";
                document.getElementById('textRecarga').innerText = "$ 1.00 " + suffix;
            }
        }

        async function fazerLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('btnLogin');

            if (!email || !password) return mostrarErro("Preencha todos os campos.");

            btn.disabled = true;
            btn.innerText = "Entrando...";
            feedback.classList.add('hidden');

            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                mostrarErro("E-mail ou senha inv√°lidos.");
                btn.disabled = false;
                btn.innerText = translations[currentLang]['btn_login'];
            } else {
                carregarDashboard(data.user);
            }
        }

        function mostrarErro(msg) {
            feedback.innerText = msg;
            feedback.classList.remove('hidden');
        }

        async function sair() {
            await supabaseClient.auth.signOut();
            location.reload();
        }

        async function carregarDashboard(user) {
            loginScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            document.getElementById('userEmail').innerText = user.email;

            const { data: profile } = await supabaseClient.from('profiles').select('*').eq('user_id', user.id).single();
            
            const hoje = new Date();
            const dataCriacao = new Date(user.created_at);
            const fimAssinatura = profile?.data_fim_assinatura ? new Date(profile.data_fim_assinatura) : null;
            
            const userMeta = user.user_metadata || {};
            const appMeta = user.app_metadata || {};
            const profileData = profile || {};
            const tudoJunto = JSON.stringify({ ...userMeta, ...appMeta, ...profileData }).toLowerCase();
            const IS_VITALICIO = tudoJunto.includes('vitalicio') || tudoJunto.includes('fundador') || tudoJunto.includes('admin');
            const horasDeVida = Math.abs(hoje - dataCriacao) / 36e5;
            const CONTA_NOVA = horasDeVida < 120; // 5 dias (120 horas)
            const E_AVALIADOR = user.email.toLowerCase().includes('avaliador'); 
            const DEVE_CAMUFLAR = CONTA_NOVA || E_AVALIADOR || IS_VITALICIO;

            let statusBadge = "EXPIRADO";
            let statusBadgeClass = "bg-red-light";
            let mensagemKey = "msg_expired";
            let isPremium = false;
            let mostrarBarra = false;
            let mostrarQuarentena = false;

            // Reseta visualiza√ß√£o
            // INCLU√çDO 'areaSeletor' no reset
            ['areaPagamento', 'areaQuarentena', 'areaPremium', 'areaRecargas', 'progressContainer', 'areaSeletor'].forEach(id => document.getElementById(id).classList.add('hidden'));

            if (DEVE_CAMUFLAR) {
                mostrarQuarentena = true;
                statusBadge = "ATIVO"; statusBadgeClass = "bg-green-light";
                mensagemKey = "msg_new_account";
                document.getElementById('areaQuarentena').classList.remove('hidden');
                // CAMUFLAGEM: Mant√©m a data oculta e N√ÉO remove o hidden do areaSeletor
                document.getElementById('infoDate').innerText = "--/--/----";

            } else if (fimAssinatura && fimAssinatura > hoje) {
                isPremium = true;
                statusBadge = "ATIVO"; statusBadgeClass = "bg-green-light";
                mensagemKey = "msg_premium";
                document.getElementById('areaPremium').classList.remove('hidden');
                document.getElementById('areaRecargas').classList.remove('hidden');
                // PREMIUM V√ä O SELETOR DE MOEDAS (PARA RECARGAS)
                document.getElementById('areaSeletor').classList.remove('hidden');
                
                document.getElementById('infoDate').innerText = fimAssinatura.toLocaleDateString('pt-BR');

            } else {
                const diasUso = (hoje - dataCriacao) / (1000 * 3600 * 24);
                if ((7 - diasUso) > 0) {
                    statusBadge = "TESTE"; statusBadgeClass = "bg-green-light";
                    mensagemKey = "msg_trial";
                    mostrarBarra = true;
                    document.getElementById('progressContainer').classList.remove('hidden');
                    document.getElementById('progressBar').style.width = ((diasUso / 7) * 100) + "%";
                    document.getElementById('areaRecargas').classList.remove('hidden'); 
                    document.getElementById('areaPagamento').classList.remove('hidden');
                } else {
                    document.getElementById('areaPagamento').classList.remove('hidden');
                    document.getElementById('areaRecargas').classList.remove('hidden');
                }
                // USU√ÅRIO GR√ÅTIS V√ä O SELETOR DE MOEDAS
                document.getElementById('areaSeletor').classList.remove('hidden');
                
                document.getElementById('infoDate').innerText = "--/--/----";
            }

            document.getElementById('userName').innerText = profile?.nome?.split(' ')[0] || user.email.split('@')[0];
            document.getElementById('infoPlan').innerText = isPremium ? "Premium" : (mostrarQuarentena ? "Standard" : "Free");
            document.getElementById('badgeStatus').innerText = statusBadge;
            document.getElementById('badgeStatus').className = "status-badge " + statusBadgeClass;
            document.getElementById('statusMessage').innerText = translations[currentLang][mensagemKey];
            
            document.getElementById('debugInfo').innerText = "ID: " + user.id.slice(0,8) + " | Camuflagem: " + DEVE_CAMUFLAR;
        }

        // --- FUN√á√ïES DO MODAL ---
        function fecharModalMP() {
            document.getElementById('modal-mp-overlay').style.display = 'none';
        }

        function mascaraCPF(i) {
            var v = i.value;
            if(isNaN(v[v.length-1])){ i.value = v.substring(0, v.length-1); return; }
            i.setAttribute("maxlength", "14");
            if (v.length == 3 || v.length == 7) i.value += ".";
            if (v.length == 11) i.value += "-";
        }

        async function confirmarPagamentoMP() {
            const nome = document.getElementById('mp-nome').value;
            const sobrenome = document.getElementById('mp-sobrenome').value;
            const cpf = document.getElementById('mp-cpf').value;
            const btnPay = document.querySelector('.mp-btn-pay');

            // Usa tradu√ß√£o para o alerta
            if (!nome || !sobrenome || cpf.length < 11) {
                alert(translations[currentLang].alert_fill_all);
                return;
            }

            btnPay.innerText = translations[currentLang].alert_processing;
            btnPay.disabled = true;

            try {
                const payload = {
                    type: pedidoAtual.type, // O Backend usa isso para saber o pre√ßo
                    email: pedidoAtual.email,
                    user_id: pedidoAtual.user_id,
                    firstName: nome,
                    lastName: sobrenome,
                    docNumber: cpf 
                };

                const response = await fetch(`${SUPABASE_URL}/functions/v1/mercadopago`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                const dados = await response.json();
                
                if (dados.init_point) {
                    window.location.href = dados.init_point;
                } else {
                    alert(translations[currentLang].alert_error_pay + (dados.error || "Tente novamente."));
                    btnPay.disabled = false;
                    btnPay.innerText = translations[currentLang].btn_pay;
                }
            } catch (e) {
                console.error(e);
                alert(translations[currentLang].alert_conn_error);
                btnPay.disabled = false;
                btnPay.innerText = translations[currentLang].btn_pay;
            }
        }

        async function pagar(tipo) {
            const btnOriginal = event.currentTarget;
            const originalHTML = btnOriginal.innerHTML;
            btnOriginal.style.opacity = "0.7";
            btnOriginal.innerHTML = "<div style='text-align:center; padding:15px; font-weight:bold; color:#2980B9;'>...</div>";

            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                let functionUrl = "";
                let typeParaBackend = tipo === 'recarga' ? 'recarga' : tipo; 

                if (currentRegion === 'br') {
                    // --- BRASIL (MERCADO PAGO) ---
                    // Abre modal
                    pedidoAtual = { 
                        type: typeParaBackend, 
                        email: user.email, 
                        user_id: user.id 
                    };
                    
                    document.getElementById('modal-mp-overlay').style.display = 'flex';
                    
                    btnOriginal.innerHTML = originalHTML;
                    btnOriginal.style.opacity = "1";
                    return; 

                } else {
                    // --- INTERNATIONAL (STRIPE) ---
                    functionUrl = `${SUPABASE_URL}/functions/v1/stripe/checkout`;
                    const payloadStripe = { 
                        type: typeParaBackend, 
                        email: user.email, 
                        user_id: user.id 
                    };

                    const response = await fetch(functionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        },
                        body: JSON.stringify(payloadStripe)
                    });

                    const dados = await response.json();
                    const linkDestino = dados.init_point || dados.url;

                    if (linkDestino) {
                        window.location.href = linkDestino;
                    } else {
                        alert("Error: " + (dados.error || "Unknown"));
                        btnOriginal.innerHTML = originalHTML;
                        btnOriginal.style.opacity = "1";
                    }
                }
            } catch (error) {
                console.error(error);
                alert("Erro Conex√£o / Connection Error");
                btnOriginal.innerHTML = originalHTML;
                btnOriginal.style.opacity = "1";
            }
        }
    </script>
</body>
</html>